{% assign stats = IDX_0 %}
{% assign system = IDX_1.system %}
{% assign sensors = IDX_2.sensors %}
{% assign history = IDX_3.history %}
{% assign top_data = IDX_4.domains %}
{% assign host_data = IDX_5.host %}
{% assign chart_id = "pihole-chart" | append_random %}

<script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
<script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>

<div class="layout layout--col">
  <!-- Top 4 Metrics -->
  <div class="item mb--2">
    <div class="meta"></div>
    <div class="content">
      <span class="value value--tnums">{{ stats.queries.total | divided_by: 1000.0 | round: 1 }}k</span>
      <span class="label label--gray">Requests</span>
    </div>
    <div class="meta"></div>
    <div class="content">
      <span class="value value--tnums">{{ stats.queries.blocked | number_with_delimiter }}</span>
      <span class="label label--gray">Blocked</span>
    </div>
    <div class="meta"></div>
    <div class="content">
      <span class="value value--tnums">{{ stats.queries.percent_blocked | round: 1 }}%</span>
      <span class="label label--gray">% Blocked</span>
    </div>
    <div class="meta"></div>
    <div class="content">
      <span class="value value--tnums">{{ stats.queries.frequency | round: 2 }}q/s</span>
      <span class="label label--gray">Frequency</span>
    </div>
  </div>

  <!-- System Stats Row -->
  <div class="item mb--4">
    <div class="meta"></div>
    
    <div class="content">
      <span class="label label--small label--inverted mr--1 flex flex--center-y">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr--0">
          <path d="M12 15.9998C11.4477 15.9998 11 16.4475 11 16.9998C11 17.5521 11.4477 17.9998 12 17.9998C12.5523 17.9998 13 17.5521 13 16.9998C13 16.4475 12.5523 15.9998 12 15.9998ZM12 15.9998L12.0071 10.5M12 16.9998L12.0071 17.0069M16 16.9998C16 19.209 14.2091 20.9998 12 20.9998C9.79086 20.9998 8 19.209 8 16.9998C8 15.9854 8.37764 15.0591 9 14.354L9 6C9 4.34315 10.3431 3 12 3C13.6569 3 15 4.34315 15 6V14.354C15.6224 15.0591 16 15.9854 16 16.9998Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Temp&nbsp;
      </span>
      <span class="value value--xsmall value--tnums">{{ sensors.cpu_temp | round: 1 }}°{{ sensors.unit }}</span>
    </div>

    <div class="meta"></div>
    
    <div class="content">
      <span class="label label--small label--inverted mr--1 flex flex--center-y">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr--1">
          <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
          <rect x="9" y="9" width="6" height="6"></rect>
          <line x1="9" y1="1" x2="9" y2="4"></line>
          <line x1="15" y1="1" x2="15" y2="4"></line>
          <line x1="9" y1="20" x2="9" y2="23"></line>
          <line x1="15" y1="20" x2="15" y2="23"></line>
          <line x1="20" y1="9" x2="23" y2="9"></line>
          <line x1="20" y1="15" x2="23" y2="15"></line>
          <line x1="1" y1="9" x2="4" y2="9"></line>
          <line x1="1" y1="15" x2="4" y2="15"></line>
        </svg>
        CPU&nbsp;
      </span>
      <span class="value value--xsmall value--tnums">{{ system.cpu["%cpu"] | round: 1 }}%</span>
    </div>

    <div class="meta"></div>
    
    <div class="content">
      <span class="label label--small label--inverted mr--1 flex flex--center-y">
        <svg width="12" height="12" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="mr--1">
          <path fill="none" stroke="currentColor" stroke-width="1.91" d="M21.55,11.05a1,1,0,0,0,.95.95v6.68H1.5V12a1,1,0,0,0,0-1.91V5.32h21v4.77A1,1,0,0,0,21.55,11.05Z"/><polygon fill="none" stroke="currentColor" stroke-width="1.91" points="13.91 9.14 10.09 9.14 6.27 9.14 6.27 12.96 10.09 12.96 13.91 12.96 17.73 12.96 17.73 9.14 13.91 9.14"/><line fill="none" stroke="currentColor" stroke-width="1.91" x1="4.36" y1="15.82" x2="4.36" y2="18.68"/><line fill="none" stroke="currentColor" stroke-width="1.91" x1="8.18" y1="15.82" x2="8.18" y2="18.68"/><line fill="none" stroke="currentColor" stroke-width="1.91" x1="12" y1="15.82" x2="12" y2="18.68"/><line fill="none" stroke="currentColor" stroke-width="1.91" x1="15.82" y1="15.82" x2="15.82" y2="18.68"/><line fill="none" stroke="currentColor" stroke-width="1.91" x1="19.64" y1="15.82" x2="19.64" y2="18.68"/>
        </svg>
        RAM&nbsp;
      </span>
      <span class="value value--xsmall value--tnums">{{ system.memory.ram["%used"] | round: 1 }}%</span>
    </div>

    <div class="meta"></div>
    
    <div class="content">
      <span class="label label--small label--inverted mr--1 flex flex--center-y">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="mr--1">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M11.0055 2H12.9945C14.3805 1.99999 15.4828 1.99999 16.3716 2.0738C17.2819 2.14939 18.0575 2.30755 18.7658 2.67552C19.8617 3.24477 20.7552 4.13829 21.3245 5.23415C21.6925 5.94253 21.8506 6.71811 21.9262 7.62839C22 8.51722 22 9.6195 22 11.0055V12.9945C22 14.3805 22 15.4828 21.9262 16.3716C21.8506 17.2819 21.6925 18.0575 21.3245 18.7658C20.7552 19.8617 19.8617 20.7552 18.7658 21.3245C18.0575 21.6925 17.2819 21.8506 16.3716 21.9262C15.4828 22 14.3805 22 12.9945 22H11.0055C9.6195 22 8.51722 22 7.62839 21.9262C6.71811 21.8506 5.94253 21.6925 5.23415 21.3245C4.13829 20.7552 3.24477 19.8617 2.67552 18.7658C2.30755 18.0575 2.14939 17.2819 2.0738 16.3716C1.99999 15.4828 1.99999 14.3805 2 12.9945V11.0055C1.99999 9.61949 1.99999 8.51721 2.0738 7.62839C2.14939 6.71811 2.30755 5.94253 2.67552 5.23415C3.24477 4.13829 4.13829 3.24477 5.23415 2.67552C5.94253 2.30755 6.71811 2.14939 7.62839 2.0738C8.51721 1.99999 9.61949 1.99999 11.0055 2ZM7.79391 4.06694C7.00955 4.13207 6.53142 4.25538 6.1561 4.45035C5.42553 4.82985 4.82985 5.42553 4.45035 6.1561C4.25538 6.53142 4.13207 7.00955 4.06694 7.79391C4.0008 8.59025 4 9.60949 4 11.05V12.95C4 14.3905 4.0008 15.4097 4.06694 16.2061C4.13207 16.9905 4.25538 17.4686 4.45035 17.8439C4.82985 18.5745 5.42553 19.1702 6.1561 19.5497C6.53142 19.7446 7.00955 19.8679 7.79391 19.9331C8.59025 19.9992 9.60949 20 11.05 20H12.95C14.3905 20 15.4097 19.9992 16.2061 19.9331C16.9905 19.8679 17.4686 19.7446 17.8439 19.5497C18.5745 19.1702 19.1702 18.5745 19.5497 17.8439C19.7446 17.4686 19.8679 16.9905 19.9331 16.2061C19.9992 15.4097 20 14.3905 20 12.95V11.05C20 9.60949 19.9992 8.59025 19.9331 7.79391C19.8679 7.00955 19.7446 6.53142 19.5497 6.1561C19.1702 5.42553 18.5745 4.82985 17.8439 4.45035C17.4686 4.25538 16.9905 4.13207 16.2061 4.06694C15.4097 4.0008 14.3905 4 12.95 4H11.05C9.60949 4 8.59025 4.0008 7.79391 4.06694ZM11.8284 6.75736C12.3807 6.75736 12.8284 7.20507 12.8284 7.75736V12.7245L16.3553 14.0653C16.8716 14.2615 17.131 14.8391 16.9347 15.3553C16.7385 15.8716 16.1609 16.131 15.6447 15.9347L11.4731 14.349C11.085 14.2014 10.8284 13.8294 10.8284 13.4142V7.75736C10.8284 7.20507 11.2761 6.75736 11.8284 6.75736Z" fill="currentColor"/>
        </svg>
        Uptime&nbsp;
      </span>
      <span class="value value--xsmall value--tnums">
        {% if system.uptime < 3600 %}
          {{ system.uptime | divided_by: 60 | round: 0 }}m
        {% else %}
          {{ system.uptime | divided_by: 3600 | round: 1 }}h
        {% endif %}
      </span>
    </div>
  </div>
</div>

<div class="title_bar">
  <div class="flex flex--center-y">
    <img class="image image-dither rounded mr--2" src="https://wp-cdn.pi-hole.net/wp-content/uploads/2016/12/Vortex-R.png" height="24" />
    <span class="title">Pi-hole</span>
  </div>
  
  <span class="instance">
    <span class="label">{{ host_data.uname.nodename }} ·</span>
    &nbsp;
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr--1">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
      <circle cx="9" cy="7" r="4"></circle>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
    </svg>
    {{ stats.clients.active }} Clients · Updated {{ "now" | date: '%s' | plus: trmnl.user.utc_offset | date: "%H:%M" }}
  </span>
</div>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function() {
    var chartData = [];
    
    {% for h in history limit:24 %}
      var timestamp = new Date({{ h.timestamp | times: 1000 }});
      var hour = timestamp.getHours();
      var minute = timestamp.getMinutes();
      var timeLabel = hour + ":" + (minute < 10 ? "0" : "") + minute;
      
      chartData.push({
        name: timeLabel,
        blocked: {{ h.blocked }},
        cached: {{ h.cached }},
        forwarded: {{ h.forwarded }}
      });
    {% endfor %}
    
    var blockedData = chartData.map(function(d) { return [d.name, d.blocked]; });
    var cachedData = chartData.map(function(d) { return [d.name, d.cached]; });
    var forwardedData = chartData.map(function(d) { return [d.name, d.forwarded]; });
    
    Highcharts.chart("{{ chart_id }}", {
      chart: {
        type: "column",
        height: 180,
        width: null,
        animation: false
      },
      title: {
        text: null
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          animation: false,
          enableMouseTracking: false,
          states: {
            hover: { enabled: false }
          },
          pointPadding: 0.05,
          groupPadding: 0.1,
          borderWidth: 0
        }
      },
      series: [{
        name: "Blocked",
        data: blockedData,
        color: "#000000",
        zIndex: 3
      }, {
        name: "Cached",
        data: cachedData,
        zIndex: 2,
        color: {
          pattern: {
            image: "https://usetrmnl.com/images/grayscale/gray-3.png",
            width: 12,
            height: 12
          }
        }
      }, {
        name: "Forwarded",
        data: forwardedData,
        zIndex: 1,
        color: {
          pattern: {
            image: "https://usetrmnl.com/images/grayscale/gray-5.png",
            width: 12,
            height: 12
          }
        }
      }],
      tooltip: { enabled: false },
      legend: { enabled: false },
      yAxis: {
        labels: {
          style: { fontSize: "14px", color: "#000000" }
        },
        gridLineWidth: 0,
        tickAmount: 4,
        title: {
          text: null
        }
      },
      xAxis: {
        type: "category",
        labels: {
          style: { fontSize: "11px", color: "#000000" },
          padding: 5,
          y: 20,
          rotation: 0
        },
        lineWidth: 0,
        tickWidth: 0,
        tickLength: 0,
        gridLineWidth: 0,
        title: {
          text: null
        }
      },
      credits: {
        enabled: false
      }
    });
  });
</script>