{% assign stats = IDX_0 %}
{% assign system = IDX_1.system %}
{% assign sensors = IDX_2.sensors %}
{% assign history = IDX_3.history %}
{% assign top_data = IDX_4.domains %}
{% assign chart_id = "pihole-chart" | append_random %}

<script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>

<div class="screen">
  <div class="view view--full">
    <div class="layout layout--col gap--space-between">

      <!-- Top 4 Metrics -->
      <div class="item mb--4">
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.total | divided_by: 1000.0 | round: 1 }}k</span>
          <span class="label label--small label--gray">Requests</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.blocked | number_with_delimiter }}</span>
          <span class="label label--small label--gray">Blocked</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.percent_blocked | round: 1 }}%</span>
          <span class="label label--small label--gray">% Blocked</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.unique_domains | divided_by: 1000.0 | round: 1 }}k</span>
          <span class="label label--small label--gray">Unique Domains</span>
        </div>
      </div>

      <!-- Bottom: Chart + Domains Table -->
      <div class="columns">
        <!-- Left Column: System Stats + Chart -->
        <div class="column">
          <!-- System Info -->
          <div class="grid grid--cols-4 mb--3">
            <div class="flex flex--col gap--xsmall">
              <span class="value value--xsmall value--tnums">{{ sensors.cpu_temp | round: 1 }}°{{ sensors.unit }}</span>
              <span class="label label--xsmall label--gray">Temp</span>
            </div>
            <div class="flex flex--col gap--xsmall">
              <span class="value value--xsmall value--tnums">{{ system.cpu.load.percent[0] | round: 1 }}%</span>
              <span class="label label--xsmall label--gray">CPU</span>
            </div>
            <div class="flex flex--col gap--xsmall">
              <span class="value value--xsmall value--tnums">{{ system.memory.ram["%used"] | round: 1 }}%</span>
              <span class="label label--xsmall label--gray">RAM</span>
            </div>
            <div class="flex flex--col gap--xsmall">
              <span class="value value--xsmall value--tnums">{{ system.uptime | divided_by: 3600 | round: 1 }}h</span>
              <span class="label label--xsmall label--gray">Uptime</span>
            </div>
          </div>

          <!-- Chart -->
          <div id="{{ chart_id }}" style="width: 100%;"></div>
          
          <!-- Chart Legend - Centered -->
          <div class="flex gap--medium mt--2" style="justify-content: center;">
            <span class="label label--small flex flex--center-y gap--xsmall">
              <div class="w--3 h--3 bg--black"></div>
              Blocked
            </span>
            <span class="label label--small flex flex--center-y gap--xsmall">
              <div class="w--3 h--3 bg--gray-45"></div>
              Permitted
            </span>
          </div>
        </div>

        <!-- Right Column: Top Blocked Domains -->
        <div class="column pl--4 pr--2">
          <span class="label mb--2 block">Top Blocked Domains</span>
          <table class="table table--condensed">
            <tbody>
              {% if top_data %}
                {% for d in top_data limit:10 %}
                  <tr>
                    <td style="width: 60%; padding-right: 8px;"><span class="label label--small" data-clamp="1">{{ d.domain }}</span></td>
                    <td style="width: 40%; text-align: right; padding-right: 12px;"><span class="label label--small">{{ d.count }}</span></td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td><span class="label label--small">No data available</span></td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Title Bar -->
    <div class="title_bar">
      <span class="title">Pi-hole</span>
      <span class="instance">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        {{ stats.clients.active }} Clients · Updated {{ "now" | date: "%H:%M" }}
      </span>
    </div>

  </div>
</div>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function() {
    var chartData = [];

    {% for h in history limit:24 %}
      var timestamp = new Date({{ h.timestamp | times: 1000 }});
      var hour = timestamp.getHours();
      chartData.push({
        name: hour + ":00",
        blocked: {{ h.blocked }},
        permitted: {{ h.total | minus: h.blocked }}
      });
    {% endfor %}

    var blockedData = chartData.map(function(d) { return [d.name, d.blocked]; });
    var permittedData = chartData.map(function(d) { return [d.name, d.permitted]; });

    Highcharts.chart("{{ chart_id }}", {
      chart: {
        type: "column",
        height: 220,
        width: null,
        animation: false,
        spacing: [10, 10, 5, 10]
      },
      title: {
        text: null
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          animation: false,
          enableMouseTracking: false,
          states: {
            hover: { enabled: false }
          },
          pointPadding: 0.05,
          groupPadding: 0.1,
          borderWidth: 0
        }
      },
      series: [{
        name: "Blocked",
        data: blockedData,
        color: "#000000"
      }, {
        name: "Permitted",
        data: permittedData,
        color: "#CCCCCC"
      }],
      tooltip: { enabled: false },
      legend: { enabled: false },
      yAxis: {
        labels: {
          style: { fontSize: "14px", color: "#000000" }
        },
        gridLineWidth: 0,
        tickAmount: 4,
        title: {
          text: null
        }
      },
      xAxis: {
        type: "category",
        labels: {
          style: { fontSize: "12px", color: "#000000" },
          padding: 5,
          y: 20
        },
        lineWidth: 0,
        tickWidth: 0,
        tickLength: 0,
        gridLineWidth: 0,
        title: {
          text: null
        }
      },
      credits: {
        enabled: false
      }
    });
  });
</script>