{% assign stats = IDX_0 %}
{% assign system = IDX_1.system %}
{% assign sensors = IDX_2.sensors %}
{% assign history = IDX_3.history %}
{% assign top_data = IDX_4.domains %}
{% assign chart_id = "pihole-chart" | append_random %}

<script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
<script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>

    <div class="layout layout--col">

      <!-- Top 4 Metrics -->
      <div class="item mb--5">
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.total | divided_by: 1000.0 | round: 1 }}k</span>
          <span class="label label--gray">Requests</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.blocked | number_with_delimiter }}</span>
          <span class="label label--gray">Blocked</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.percent_blocked | round: 1 }}%</span>
          <span class="label label--gray">% Blocked</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ stats.queries.unique_domains | divided_by: 1000.0 | round: 1 }}k</span>
          <span class="label label--gray">Unique Domains</span>
        </div>
      </div>

      <!-- System Stats Row -->
      <div class="item mb--4">
        <div class="meta"></div>
        <div class="content">
          <span class="label label--small label--inverted">Temp</span>
          <span class="value value--xsmall value--tnums">{{ sensors.cpu_temp | round: 1 }}°{{ sensors.unit }}</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="label label--small label--inverted">CPU</span>
          <span class="value value--xsmall value--tnums">{{ system.cpu.load.percent[0] | round: 1 }}%</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="label label--small label--inverted">RAM</span>
          <span class="value value--xsmall value--tnums">{{ system.memory.ram["%used"] | round: 1 }}%</span>
        </div>
        <div class="meta"></div>
        <div class="content">
          <span class="label label--small label--inverted">Uptime</span>
          <span class="value value--xsmall value--tnums">{{ system.uptime | divided_by: 3600 | round: 1 }}h</span>
        </div>
      </div>

      <!-- Two Column Layout: Chart on Left, Domains on Right -->
      <div class="columns">
        
        <!-- Left Column: Chart -->
        <div class="column">
          <div id="{{ chart_id }}" style="width: 100%; height: 180px;"></div>
          
          <!-- Chart Legend with Pattern Swatches -->
          <div class="flex gap--medium mt--2" style="justify-content: center;">
            <span class="label label--small flex flex--center-y gap--xsmall">
              <svg width="12" height="12" style="display: block;">
                <rect width="12" height="12" fill="#000000"/>
              </svg>
              Blocked
            </span>
            <span class="label label--small flex flex--center-y gap--xsmall">
              <svg width="12" height="12" style="display: block;">
                <defs>
                  <pattern id="pattern-gray-3" patternUnits="userSpaceOnUse" width="12" height="12">
                    <image href="https://usetrmnl.com/images/grayscale/gray-3.png" x="0" y="0" width="12" height="12"/>
                  </pattern>
                </defs>
                <rect width="12" height="12" fill="url(#pattern-gray-3)"/>
              </svg>
              Cached
            </span>
            <span class="label label--small flex flex--center-y gap--xsmall">
              <svg width="12" height="12" style="display: block;">
                <defs>
                  <pattern id="pattern-gray-5" patternUnits="userSpaceOnUse" width="12" height="12">
                    <image href="https://usetrmnl.com/images/grayscale/gray-5.png" x="0" y="0" width="12" height="12"/>
                  </pattern>
                </defs>
                <rect width="12" height="12" fill="url(#pattern-gray-5)"/>
              </svg>
              Forwarded
            </span>
          </div>
        </div>

        <!-- Right Column: Top Blocked Domains -->
        <div class="column" data-overflow="true" data-overflow-max-height="220">
          <span class="label label--medium mb--2">Top Blocked</span>
          {% if top_data %}
            {% for d in top_data limit:15 %}
              <div class="item">
                <div class="meta"></div>
                <div class="content">
                  <span class="title title--small" data-clamp="1">{{ d.domain }}</span>
                  <span class="description">{{ d.count }} requests</span>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="item">
              <div class="meta"></div>
              <div class="content">
                <span class="title title--small">No data available</span>
              </div>
            </div>
          {% endif %}
        </div>

      </div>

    </div>

    <!-- Title Bar -->
    <div class="title_bar">
      <span class="title">Pi-hole</span>
      <span class="instance">{{ stats.clients.active }} Clients · Updated {{ "now" | date: "%H:%M" }}</span>
    </div>


<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function() {
    var chartData = [];

    {% for h in history limit:24 %}
      var timestamp = new Date({{ h.timestamp | times: 1000 }});
      var hour = timestamp.getHours();
      var minute = timestamp.getMinutes();
      var timeLabel = hour + ":" + (minute < 10 ? "0" : "") + minute;
      
      chartData.push({
        name: timeLabel,
        blocked: {{ h.blocked }},
        cached: {{ h.cached }},
        forwarded: {{ h.forwarded }}
      });
    {% endfor %}

    var blockedData = chartData.map(function(d) { return [d.name, d.blocked]; });
    var cachedData = chartData.map(function(d) { return [d.name, d.cached]; });
    var forwardedData = chartData.map(function(d) { return [d.name, d.forwarded]; });

    Highcharts.chart("{{ chart_id }}", {
      chart: {
        type: "column",
        height: 180,
        width: null,
        animation: false,
        spacing: [10, 10, 5, 10]
      },
      title: {
        text: null
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          animation: false,
          enableMouseTracking: false,
          states: {
            hover: { enabled: false }
          },
          pointPadding: 0.05,
          groupPadding: 0.1,
          borderWidth: 0
        }
      },
      series: [{
        name: "Blocked",
        data: blockedData,
        color: "#000000",
        zIndex: 3
      }, {
        name: "Cached",
        data: cachedData,
        zIndex: 2,
        color: {
          pattern: {
            image: "https://usetrmnl.com/images/grayscale/gray-3.png",
            width: 12,
            height: 12
          }
        }
      }, {
        name: "Forwarded",
        data: forwardedData,
        zIndex: 1,
        color: {
          pattern: {
            image: "https://usetrmnl.com/images/grayscale/gray-5.png",
            width: 12,
            height: 12
          }
        }
      }],
      tooltip: { enabled: false },
      legend: { enabled: false },
      yAxis: {
        labels: {
          style: { fontSize: "14px", color: "#000000" }
        },
        gridLineWidth: 0,
        tickAmount: 4,
        title: {
          text: null
        }
      },
      xAxis: {
        type: "category",
        labels: {
          style: { fontSize: "11px", color: "#000000" },
          padding: 5,
          y: 20,
          rotation: 0
        },
        lineWidth: 0,
        tickWidth: 0,
        tickLength: 0,
        gridLineWidth: 0,
        title: {
          text: null
        }
      },
      credits: {
        enabled: false
      }
    });
  });
</script>